# دليل نظام النسخ الاحتياطي على Supabase

## نظرة عامة
تم إعداد نظام النسخ الاحتياطي للعمل مع Supabase Storage لحفظ النسخ الاحتياطية بشكل آمن في السحابة.

## الإعدادات الحالية

### معلومات Supabase
- **URL**: https://tsyvpjhpogxmqcpeaowb.supabase.co
- **البكت**: private-schools-accounting
- **نوع التخزين**: خاص (Private)
- **الحد الأقصى لحجم الملف**: 100 ميجابايت
- **أنواع الملفات المسموحة**: ZIP, SQLite

### إعدادات النظام
تم حفظ الإعدادات في ملف `config.py`:
```python
SUPABASE_URL = "https://tsyvpjhpogxmqcpeaowb.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
SUPABASE_BUCKET = "private-schools-accounting"
```

## كيفية عمل النظام

### 1. إنشاء النسخ الاحتياطية
- يتم إنشاء ملف ZIP يحتوي على قاعدة البيانات
- يتم إضافة ملف معلومات (backup_info.txt) يحتوي على:
  - تاريخ الإنشاء
  - وصف النسخة
  - حجم قاعدة البيانات
  - إصدار التطبيق

### 2. رفع على Supabase
- يتم رفع النسخة في مجلد منظم حسب السنة والشهر
- مثال: `backups/2025/07/backup_20250727_143025.zip`
- في حالة فشل الرفع، يتم حفظ النسخة محلياً

### 3. النسخ المحلية الاحتياطية
- يتم حفظ نسخة محلية في: `data/backups/manual/`
- هذا يضمن توفر النسخ حتى لو فشل الرفع على Supabase

## الاختبارات المتاحة

### 1. اختبار الاتصال بـ Supabase
```bash
python test_supabase_detailed.py
```
يختبر:
- الاتصال بـ Supabase
- وجود البكت أو إنشاؤه
- رفع وحذف ملف تجريبي

### 2. اختبار إنشاء النسخ الاحتياطية
```bash
python test_backup_create.py
```
يختبر:
- إنشاء نسخة احتياطية كاملة
- رفعها على Supabase
- جلب قائمة النسخ

### 3. اختبار شامل
```bash
python test_supabase_backup.py
```
أو استخدم الملف الدفعي:
```bash
run_supabase_tests.bat
```

## استخدام النظام في التطبيق

### من خلال واجهة المستخدم
1. انتقل إلى صفحة "النسخ الاحتياطية"
2. اضغط على "إنشاء نسخة احتياطية"
3. أدخل وصفاً للنسخة (اختياري)
4. انتظر اكتمال العملية

### برمجياً
```python
from core.backup.backup_manager import backup_manager

# إنشاء نسخة احتياطية
success, message = backup_manager.create_backup("وصف النسخة")

# جلب قائمة النسخ
backups = backup_manager.list_backups()

# حذف نسخة
success, message = backup_manager.delete_backup("مسار_الملف")
```

## المراقبة واللوغات

### ملفات اللوغات
- `logs/app.log`: جميع عمليات التطبيق
- البحث عن رسائل تحتوي على "backup" أو "Supabase"

### رسائل اللوغات المهمة
- `✅ تم إنشاء النسخة الاحتياطية على Supabase`: نجح الرفع
- `❌ خطأ في رفع النسخة على Supabase`: فشل الرفع
- `تم حفظ النسخة محلياً كبديل`: تم الاحتفاظ بنسخة محلية

## استكشاف الأخطاء

### المشاكل الشائعة

1. **عميل Supabase غير متاح**
   - تأكد من تثبيت المكتبة: `pip install supabase`
   - تحقق من صحة المفتاح والرابط

2. **فشل في إنشاء البكت**
   - تأكد من صلاحيات المفتاح
   - تحقق من إعدادات المشروع في Supabase

3. **فشل في رفع الملفات**
   - تحقق من اتصال الإنترنت
   - تأكد من عدم تجاوز حد حجم الملف (100MB)

### حلول الطوارئ
- النظام يحفظ النسخ محلياً تلقائياً عند فشل الرفع
- يمكن إعادة رفع النسخ المحلية لاحقاً عند حل المشكلة

## الأمان

### حماية البيانات
- البكت مُعيّن كخاص (Private)
- روابط التحميل مؤقتة وتنتهي صلاحيتها
- تشفير الاتصال عبر HTTPS

### النسخ الاحتياطية
- يتم الاحتفاظ بالنسخ لمدة 30 يوماً افتراضياً
- يمكن تنظيف النسخ القديمة تلقائياً
- النسخ المحلية تبقى حتى الحذف اليدوي

## الدعم الفني

### في حالة المشاكل
1. شغل الاختبارات للتشخيص
2. راجع ملفات اللوغات
3. تأكد من إعدادات Supabase
4. تحقق من اتصال الإنترنت

### معلومات إضافية
- النظام يدعم العمل بدون Supabase (نسخ محلية فقط)
- يمكن تغيير إعدادات البكت في أي وقت
- النسخ الاحتياطية متوافقة مع جميع إصدارات التطبيق
